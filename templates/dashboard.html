{% extends 'base.html' %}
{% block title %}Desafíos | Antioquia Dialoga{% endblock %}
{% block content %}

<!-- Modal para pedir nombre (solo si no tiene username) -->
{% if needs_username %}
<div id="usernameModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl max-w-md w-full p-6">
    <h3 class="text-xl font-semibold mb-3">🌿 Bienvenido a Antioquia Dialoga</h3>
    <p class="text-slate-600 mb-4">Para comenzar tu viaje hacia la paz, cuéntanos cómo te llamas:</p>
    
    <form id="usernameForm">
      <input 
        id="usernameInput" 
        type="text" 
        class="w-full border rounded-lg px-4 py-2 mb-2 focus:outline-none focus:ring-2 focus:ring-emerald-400" 
        placeholder="Tu nombre o nickname"
        maxlength="50"
        required
        autofocus
      />
      <p class="text-xs text-slate-500 mb-4">Este nombre te identificará en el ranking y tus logros</p>
      <button 
        type="submit" 
        class="w-full px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700"
      >
        Comenzar mi viaje 🌿
      </button>
    </form>
    
    <div id="usernameError" class="hidden mt-3 p-2 rounded bg-red-50 text-red-600 text-sm"></div>
  </div>
</div>

<script>
  document.getElementById('usernameForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const username = document.getElementById('usernameInput').value.trim();
    const errorDiv = document.getElementById('usernameError');
    const submitBtn = e.target.querySelector('button[type="submit"]');
    
    // Deshabilitar botón mientras procesa
    submitBtn.disabled = true;
    submitBtn.textContent = 'Creando perfil...';
    
    try {
      const response = await fetch('/set-username/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username })
      });
      
      const data = await response.json();
      
      if (data.success) {
        window.location.reload();
      } else {
        errorDiv.textContent = data.error;
        errorDiv.classList.remove('hidden');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Comenzar mi viaje 🌿';
      }
    } catch (error) {
      errorDiv.textContent = 'Error al registrar nombre. Intenta de nuevo.';
      errorDiv.classList.remove('hidden');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Comenzar mi viaje 🌿';
    }
  });
</script>
{% endif %}

{% if profile %}
<!-- Encabezado con nombre del usuario -->
<div class="mb-5">
  <h2 class="text-2xl font-semibold">¡Hola, {{ profile.username }}! 👋</h2>
  <p class="text-slate-600">Gana puntos participando en actividades de paz. Completa tus metas diarias para subir de nivel. 🌿</p>
</div>

<!-- Stats con datos reales -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
  <div class="bg-white rounded-2xl p-4 shadow-sm">
    <p class="text-sm text-slate-500">Nivel</p>
    <div class="mt-2 flex items-end gap-2">
      <p class="text-3xl font-semibold">{{ profile.level }}</p>
    </div>
    <div class="mt-3 h-2 w-full bg-slate-100 rounded">
      <div class="h-2 bg-emerald-500 rounded" style="width: {{ progress_percent|floatformat:0 }}%;"></div>
    </div>
    <p class="mt-1 text-xs text-slate-500">{{ points_for_next }} pts al nivel {{ profile.level|add:1 }}</p>
  </div>

  <div class="bg-white rounded-2xl p-4 shadow-sm">
    <p class="text-sm text-slate-500">Puntos Totales</p>
    <div class="mt-2 flex items-end gap-2">
      <p class="text-3xl font-semibold">{{ profile.total_points }}</p>
      {% if profile.daily_points > 0 %}
      <span class="text-xs px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700">
        +{{ profile.daily_points }} hoy
      </span>
      {% endif %}
    </div>
    <p class="mt-2 text-xs text-slate-500">Meta diaria: 300</p>
    <div class="mt-1 h-2 w-full bg-slate-100 rounded">
      {% widthratio profile.daily_points 300 100 as daily_progress %}
      <div class="h-2 bg-emerald-500 rounded" style="width: {% if daily_progress > 100 %}100{% else %}{{ daily_progress }}{% endif %}%;"></div>
    </div>
  </div>

  <div class="bg-white rounded-2xl p-4 shadow-sm">
    <p class="text-sm text-slate-500">Racha</p>
    <p class="mt-2 text-3xl font-semibold">{{ profile.streak_days }}<span class="text-base font-normal"> días</span></p>
    <p class="mt-2 text-xs text-slate-500">{% if profile.streak_days > 0 %}¡Sigue así! 🔥{% else %}Empieza hoy tu racha{% endif %}</p>
  </div>

  <div class="bg-white rounded-2xl p-4 shadow-sm">
    <p class="text-sm text-slate-500">Mensajes enviados</p>
    <p class="mt-2 text-3xl font-semibold">{{ profile.messages_sent }}</p>
    <a href="{% url 'chat' %}" class="mt-2 inline-block text-emerald-700 text-sm font-medium hover:underline">Ir al chat</a>
  </div>
</div>

<!-- Stats secundarios -->
<div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
  <div class="bg-white rounded-2xl p-4 shadow-sm">
    <div class="flex items-center gap-2 mb-2">
      <span class="text-2xl">📚</span>
      <p class="text-sm text-slate-500">Historias leídas</p>
    </div>
    <p class="text-2xl font-semibold">{{ profile.stories_read }}<span class="text-base text-slate-400">/3</span></p>
    <a href="{% url 'historias' %}" class="mt-1 inline-block text-emerald-700 text-xs font-medium hover:underline">
      {% if profile.stories_read < 3 %}Leer más →{% else %}Ver historias{% endif %}
    </a>
  </div>
  
  <div class="bg-white rounded-2xl p-4 shadow-sm">
    <div class="flex items-center gap-2 mb-2">
      <span class="text-2xl">💬</span>
      <p class="text-sm text-slate-500">Conversaciones</p>
    </div>
    <p class="text-2xl font-semibold">{{ profile.conversations_count }}</p>
    <p class="text-xs text-slate-500 mt-1">Con PazBot</p>
  </div>
  
  <div class="bg-white rounded-2xl p-4 shadow-sm">
    <div class="flex items-center gap-2 mb-2">
      <span class="text-2xl">🧠</span>
      <p class="text-sm text-slate-500">Trivias completadas</p>
    </div>
    <p class="text-2xl font-semibold">{{ profile.quizzes_completed }}</p>
    <a href="{% url 'trivias' %}" class="mt-1 inline-block text-emerald-700 text-xs font-medium hover:underline">
      {% if profile.quizzes_completed < 3 %}Tomar trivias →{% else %}Ver más{% endif %}
    </a>
  </div>
</div>

<!-- Acciones rápidas -->
<div class="grid md:grid-cols-3 gap-4 mb-6">
  <a href="{% url 'chat' %}" class="group bg-white rounded-2xl p-5 shadow-sm border hover:border-emerald-200 hover:shadow-md transition">
    <div class="flex items-center gap-3">
      <div class="h-10 w-10 rounded-xl bg-emerald-100 grid place-items-center">💬</div>
      <div>
        <p class="font-semibold">Hablar con PazBot</p>
        <p class="text-sm text-slate-600">Comparte una situación y recibe guía (+10 pts/mensaje)</p>
      </div>
    </div>
    <div class="mt-3 inline-flex items-center gap-1 text-emerald-700 text-sm font-medium group-hover:underline">
      Ir al chat →
    </div>
  </a>

  <a href="{% url 'historias' %}" class="group bg-white rounded-2xl p-5 shadow-sm border hover:border-emerald-200 hover:shadow-md transition">
    <div class="flex items-center gap-3">
      <div class="h-10 w-10 rounded-xl bg-emerald-100 grid place-items-center">📚</div>
      <div>
        <p class="font-semibold">Leer una historia</p>
        <p class="text-sm text-slate-600">Aprende con storytelling interactivo</p>
      </div>
    </div>
    <div class="mt-3 inline-flex items-center gap-1 text-emerald-700 text-sm font-medium group-hover:underline">
      Explorar historias →
    </div>
  </a>

  <a href="{% url 'trivias' %}" class="group bg-white rounded-2xl p-5 shadow-sm border hover:border-emerald-200 hover:shadow-md transition">
    <div class="flex items-center gap-3">
      <div class="h-10 w-10 rounded-xl bg-emerald-100 grid place-items-center">🧠</div>
      <div>
        <p class="font-semibold">Empezar Trivia</p>
        <p class="text-sm text-slate-600">Pon a prueba tus conocimientos (hasta +60 pts)</p>
      </div>
    </div>
    <div class="mt-3 inline-flex items-center gap-1 text-emerald-700 text-sm font-medium group-hover:underline">
      Comenzar →
    </div>
  </a>
</div>

<!-- Actividades recientes -->
{% if recent_activities %}
<div class="bg-white rounded-2xl p-5 shadow-sm border mb-6">
  <h3 class="font-semibold mb-3">📊 Actividad Reciente</h3>
  <div class="space-y-2">
    {% for activity in recent_activities %}
    <div class="flex items-center justify-between py-2 border-b last:border-b-0">
      <div class="flex items-center gap-2">
        <span class="text-xs px-2 py-1 rounded bg-emerald-50 text-emerald-700">
          {{ activity.get_activity_type_display }}
        </span>
        {% if activity.description %}
        <span class="text-sm text-slate-600">{{ activity.description }}</span>
        {% endif %}
      </div>
      <div class="flex items-center gap-2">
        <span class="text-sm font-semibold text-emerald-600">+{{ activity.points_earned }} pts</span>
        <span class="text-xs text-slate-500">{{ activity.timestamp|timesince }}</span>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- Logros & Ranking -->
<div class="grid lg:grid-cols-3 gap-4">
  <!-- Logros del usuario -->
  <div class="bg-white rounded-2xl p-5 shadow-sm border lg:col-span-2">
    <div class="flex items-center justify-between mb-3">
      <h3 class="font-semibold">🏆 Tus Logros</h3>
    </div>
    {% if user_achievements %}
    <div class="flex flex-wrap gap-2">
      {% for ua in user_achievements %}
      <span class="px-3 py-1.5 rounded-full bg-emerald-100 text-emerald-700 text-sm" title="{{ ua.achievement.description }}">
        {{ ua.achievement.icon }} {{ ua.achievement.name }}
      </span>
      {% endfor %}
    </div>
    {% else %}
    <p class="text-slate-500 text-sm">Aún no has desbloqueado logros. ¡Sigue participando! 🌿</p>
    {% endif %}
  </div>

  <!-- Leaderboard con datos reales -->
  <div class="bg-white rounded-2xl p-5 shadow-sm border">
    <h3 class="font-semibold mb-3">🏅 Ranking</h3>
    {% if ranking %}
    <ol class="space-y-2">
      {% for user in ranking %}
      <li class="flex items-center justify-between {% if user.username == profile.username %}bg-emerald-50 px-2 py-1 rounded font-semibold{% endif %}">
        <span>{{ forloop.counter }}. {{ user.username }}</span>
        <span class="text-slate-600 text-sm">{{ user.total_points }} pts</span>
      </li>
      {% endfor %}
    </ol>
    {% else %}
    <p class="text-slate-500 text-sm">El ranking está vacío. ¡Sé el primero!</p>
    {% endif %}
  </div>
</div>

{% else %}
<!-- Si por alguna razón no hay perfil ni modal, mostrar mensaje -->
<div class="text-center py-12">
  <p class="text-slate-600">Cargando tu perfil...</p>
</div>
{% endif %}

{% endblock %}
